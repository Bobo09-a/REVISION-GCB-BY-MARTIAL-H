<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QCM Futuriste ‚Äì R√©vision Licence GCB</title>
  <meta name="theme-color" content="#0b0f1a" />
  <style>
    :root{ --bg:#0b0f1a;--panel:#10162a;--panel2:#0e1324;--acc:#6df0ff;--acc2:#7d7bff;--ok:#2ee59d;--bad:#ff5577;--text:#e9f3ff;--muted:#9fb2c7;--chip:#16213a; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      background:radial-gradient(1200px 700px at 70% -10%,rgba(125,123,255,.16),transparent),
                 radial-gradient(900px 600px at -20% 120%,rgba(109,240,255,.18),transparent), var(--bg);
      color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .app{max-width:760px; margin:0 auto; padding:12px 12px 80px;}
    header{ position:sticky; top:0; z-index:5; backdrop-filter:saturate(130%) blur(10px);
      background:linear-gradient(180deg, rgba(11,15,26,.92), rgba(11,15,26,.65));
      border-bottom:1px solid rgba(125,123,255,.25); }
    .bar{display:flex; align-items:center; gap:8px; padding:10px 12px; flex-wrap:wrap}
    .title{font-weight:700; letter-spacing:.2px;}
    .chip{background:var(--chip); border:1px solid rgba(109,240,255,.25); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
    select, button, input[type="text"], input[type="file"], textarea{
      background:linear-gradient(180deg,var(--panel),var(--panel2)); color:var(--text); border:1px solid rgba(125,123,255,.35); border-radius:12px;
      padding:10px 12px; font-size:14px; outline:none; width:100%;
    }
    button{cursor:pointer; transition:.2s transform ease, .2s box-shadow ease;} button:hover{transform:translateY(-1px)}
    .row{display:flex; gap:8px;} .row>*{flex:1}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:520px){ .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr} }
    .panel{border:1px solid rgba(109,240,255,.2); border-radius:16px; background:linear-gradient(180deg, rgba(22,28,50,.72), rgba(12,17,33,.72)); box-shadow:0 8px 24px rgba(0,0,0,.25);}
    .panel .p{padding:14px;}
    .ghost{background:transparent; border:1px dashed rgba(125,123,255,.35)}
    .progress{height:8px; width:100%; background:#0b1120; border-radius:999px; overflow:hidden; border:1px solid rgba(125,123,255,.25)}
    .progress>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--acc),var(--acc2)); transition:width .25s ease}
    .badge{padding:6px 10px; border-radius:999px; border:1px solid rgba(125,123,255,.35); font-size:12px; color:var(--muted)}
    .q-title{font-weight:700; font-size:18px; line-height:1.3}
    .choices{display:grid; gap:10px;}
    .choice{display:flex; gap:10px; align-items:flex-start; padding:10px; border:1px solid rgba(125,123,255,.35); border-radius:12px; background:linear-gradient(180deg,var(--panel),var(--panel2)); cursor:pointer}
    .choice input{margin-top:4px}
    .actions{display:flex; gap:10px;}
    .h{height:1px; background:linear-gradient(90deg, transparent, rgba(109,240,255,.35), transparent); border:0; margin:12px 0}
    .score{font-weight:700}
    .pill{padding:4px 8px; border-radius:999px;} .ok{color:#062; background:linear-gradient(180deg, rgba(46,229,157,.25), rgba(46,229,157,.1)); border:1px solid rgba(46,229,157,.4)}
    .bad{color:#620; background:linear-gradient(180deg, rgba(255,85,119,.25), rgba(255,85,119,.1)); border:1px solid rgba(255,85,119,.4)}
    .imgwrap{border:1px solid rgba(125,123,255,.35); border-radius:12px; overflow:hidden; background:#0b1120}
    .imgwrap img{display:block; width:100%; height:auto}
    .footer{position:fixed; bottom:0; left:0; right:0; padding:10px; background:linear-gradient(180deg, rgba(11,15,26,.0), rgba(11,15,26,.95)); backdrop-filter: blur(8px); border-top:1px solid rgba(125,123,255,.25)}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">üìö R√©visions GCB ‚Äì QCM Futuriste</div>
      <div class="chip" id="version">v1.5</div>
      <div class="chip" id="timerBadge">Sans minuteur</div>
    </div>
    <div class="bar" style="gap:10px;">
      <div class="row" style="flex:3">
        <select id="subjectSelect" aria-label="Choisir une mati√®re"></select>
        <select id="filterType" aria-label="Filtrer par type">
          <option value="">Tous les types</option>
          <option>QCM</option>
          <option>Questions/R√©ponses</option>
          <option>IDENTIFICATION IMAGE</option>
          <option>√âTUDES DE CAS</option>
        </select>
        <select id="modeSelect" aria-label="Choisir un mode">
          <option value="normal">Mode normal</option>
          <option value="random">Mode al√©atoire</option>
          <option value="weak">Mode faiblesses</option>
          <option value="exam30">Mode examen (30 min)</option>
          <option value="flash">Flashcards</option>
        </select>
        <button id="btnStart">D√©marrer</button>
      </div>
      <div class="row" style="flex:2">
        <button id="btnLoad">Importer questions (.json)</button>
        <button id="btnSave" class="ghost">Exporter banque</button>
      </div>
    </div>
  </header>

  <div class="app">
    <div class="grid">
      <div class="panel">
        <div class="p">
          <div class="row" style="align-items:center; gap:12px">
            <div class="badge">Score: <span class="score" id="score">0</span></div>
            <div class="badge">Question <span id="qIndex">0</span>/<span id="qTotal">0</span></div>
            <div class="badge">Mati√®re: <span id="subjectLabel">‚Äî</span></div>
            <div class="badge">Mode: <span id="modeLabel">normal</span></div>
          </div>
          <div class="progress" style="margin:10px 0 4px"><i id="progressBar"></i></div>
        </div>
      </div>

      <div class="panel" id="card">
        <div class="p" id="stage">
          <p style="color:var(--muted); margin:0">
            Place tes fichiers <b>.json</b> √† la <b>racine</b> du d√©p√¥t : l‚Äôapp les charge automatiquement (scan GitHub API).<br/>
            R√®gles : juste = <b>+1</b>, erreur = <b>‚àí1</b>.
          </p>
        </div>
      </div>

      <div class="panel">
        <div class="p grid-2">
          <button id="btnPrev">‚üµ Pr√©c√©dent</button>
          <button id="btnNext">Suivant ‚ü∂</button>
        </div>
      </div>

      <details class="panel">
        <summary class="p">üìä Statistiques & progression</summary>
        <div class="p grid-3">
          <div class="badge">Vues: <b id="stSeen">0</b></div>
          <div class="badge">Bonnes: <b id="stGood">0</b></div>
          <div class="badge">Mauvaises: <b id="stBad">0</b></div>
          <div class="badge">Pr√©cision: <b id="stAcc">0%</b></div>
          <div class="badge">S√©rie actuelle: <b id="stStreak">0</b></div>
          <div class="badge">√Ä revoir: <b id="stToReview">0</b></div>
        </div>
      </details>

      <details class="panel">
        <summary class="p">‚ÑπÔ∏è Format de la banque (pour import)</summary>
        <div class="p">
<pre style="white-space:pre-wrap; font-size:12px; color:var(--muted); margin:0">
{ "subjects": [ { "name": "Bact√©riologie", "sections": [
  { "name": "QCM", "questions": [ {"type":"mcq","prompt":"...", "choices":["A","B"], "answer":0, "explain":"..."} ]},
  { "name": "Questions/R√©ponses", "questions": [ {"type":"short","prompt":"...", "answer_text":"...", "explain":"..."} ]},
  { "name": "IDENTIFICATION IMAGE", "questions": [ {"type":"image-id","prompt":"...", "image":"fichier.jpg","mode":"text","answer_text":"..."} ]},
  { "name": "√âTUDES DE CAS", "questions": [ {"type":"short","prompt":"Cas ...","answer_text":"...", "explain":"..."} ]}
]} ] }
</pre>
          <div class="badge">üí° Mets toutes les <b>images</b> (si utilis√©es) √† la <b>racine</b> aussi et r√©f√©rence le <b>nom de fichier</b> uniquement.</div>
        </div>
      </details>
    </div>
  </div>

  <div class="footer">
    <div class="app">
      <div class="row">
        <button id="btnMarkReview" class="ghost">Marquer √† revoir</button>
        <button id="btnShowExplain" class="ghost">Afficher l'explication</button>
        <button id="btnReset" class="ghost">R√©initialiser la session</button>
      </div>
    </div>
  </div>

  <input id="fileInput" type="file" accept="application/json" hidden />

  <script>
  // --- State ---
  const el = (id)=>document.getElementById(id);
  const S = {
    bank: { subjects: [] },
    subjectIndex: -1,
    mode: 'normal',             // normal | random | weak | exam30 | flash
    filterType: '',             // '', 'QCM', 'Questions/R√©ponses', 'IDENTIFICATION IMAGE', '√âTUDES DE CAS'
    queue: [],                  // liste aplatie des questions courantes
    qIndex: 0,
    score: 0,
    answered: false,
    reviewSet: new Set(),       // marqu√©es √† revoir (manuel)
    perf: {},                   // perf par question key: {seen, good, bad}
    streak: 0,
    timer: {active:false, left:0, t:null}, // examen
  };

  // ---- Fallback manuel si pas Github.io ou si API rate ----
  const DATA_FILES = [
    './bacteriologie.json',
    './biochimie_analytique.json'
    // Ajoute ici d'autres fichiers si besoin (fallback)
  ];

  // --- Demo bank (fallback ultime) ---
  const demo = {
    subjects:[ { name:"D√©mo", sections:[
      {name:"QCM", questions:[
        {type:"mcq", prompt:"Les bacilles Gram n√©gatif parmi les suivants sont :", choices:["Staphylococcus","Escherichia coli","Streptococcus"], answer:1, explain:"E. coli est un bacille Gram n√©gatif."}
      ]},
      {name:"Questions/R√©ponses", questions:[
        {type:"short", prompt:"D√©finir antisepsie.", answer_text:"Proc√©d√© visant √† d√©truire ou inhiber les micro-organismes sur les tissus vivants.", explain:"Antisepsie ‚â† d√©sinfection (milieux inertes)."}
      ]}
    ] } ]
  };

  // ----------- Auto-scan GitHub Contents API -----------
  async function discoverJsonUrls() {
    try {
      const isGh = location.host.endsWith('github.io');
      if (!isGh) return DATA_FILES;

      // owner = sous-domaine avant .github.io ; repo = 1er segment de path
      const owner = location.host.split('.github.io')[0];
      const pathParts = location.pathname.split('/').filter(Boolean);
      const repo = pathParts[0] || '';
      if (!owner || !repo) return DATA_FILES;

      const api = `https://api.github.com/repos/${owner}/${repo}/contents/`;
      const res = await fetch(api, {headers:{'Accept':'application/vnd.github+json'}});
      if (!res.ok) throw new Error('GitHub API non disponible');
      const list = await res.json();

      const urls = [];
      for (const item of list) {
        if (item.type === 'file' && /\.json$/i.test(item.name)) {
          // Option : ignorer certains json techniques
          if (/^package(-lock)?\.json$/i.test(item.name)) continue;
          // utiliser download_url pour r√©cup√©rer le brut (CORS OK)
          urls.push(item.download_url);
        }
      }
      // si rien d√©tect√©, on retombe sur DATA_FILES
      return urls.length ? urls : DATA_FILES;
    } catch(e) {
      console.warn('Scan GitHub API √©chou√©, fallback DATA_FILES:', e);
      return DATA_FILES;
    }
  }

  async function loadBankFromFiles() {
    const merged = { subjects: [] };
    const seenNames = new Set();

    const urls = await discoverJsonUrls();
    for (const url of urls) {
      try {
        const res = await fetch(url + (url.includes('?')?'&':'?') + 'v=' + Date.now()); // anti-cache
        if (!res.ok) continue;
        const json = await res.json();
        if (Array.isArray(json.subjects)) {
          for (const subj of json.subjects) {
            const name = String(subj.name || '').trim();
            if (name && !seenNames.has(name)) {
              merged.subjects.push(subj);
              seenNames.add(name);
            } else if (name) {
              // fusion douce si m√™me mati√®re (concat sections)
              const target = merged.subjects.find(s=>s.name===name);
              if (target && Array.isArray(subj.sections)) {
                target.sections = [...(target.sections||[]), ...subj.sections];
              }
            }
          }
        }
      } catch(e) {
        console.warn('√âchec chargement', url, e);
      }
    }
    return merged.subjects.length ? merged : null;
  }

  // --- Init ---
  async function init(){
    const repoBank = await loadBankFromFiles();
    if (repoBank) {
      S.bank = repoBank;
      localStorage.setItem('qcm_bank_v1', JSON.stringify(S.bank));
    } else {
      const saved = localStorage.getItem('qcm_bank_v1');
      S.bank = saved ? JSON.parse(saved) : demo;
    }
    refreshSubjectList();
    bind();
    renderIdle();
  }

  function bind(){
    el('btnStart').onclick = start;
    el('btnNext').onclick = ()=> nav(1);
    el('btnPrev').onclick = ()=> nav(-1);
    el('btnReset').onclick = reset;
    el('btnSave').onclick = saveBank;
    el('btnLoad').onclick = ()=> el('fileInput').click();
    el('fileInput').onchange = onImport;
    el('btnShowExplain').onclick = toggleExplain;
    el('btnMarkReview').onclick = toggleReview;
    el('filterType').onchange = (e)=> { S.filterType = e.target.value || ''; };
    el('modeSelect').onchange = (e)=> { S.mode = e.target.value; el('modeLabel').textContent = S.mode; updateTimerBadge(); };
  }

  function refreshSubjectList(){
    const sel = el('subjectSelect'); sel.innerHTML='';
    S.bank.subjects.forEach((s, i)=>{
      const o=document.createElement('option'); o.value=i; o.textContent=s.name; sel.appendChild(o);
    });
  }

  function start(){
    const idx = parseInt(el('subjectSelect').value || '0',10);
    S.subjectIndex = isNaN(idx) ? 0 : idx;
    S.score = 0; S.answered=false; S.streak=0; S.qIndex=0;
    buildQueue();
    setupExamTimerIfNeeded();
    render();
  }

  function buildQueue(){
    const subj = S.bank.subjects[S.subjectIndex]; if(!subj){ S.queue=[]; return; }
    let flat = subj.sections.flatMap(s=>{
      if(S.filterType && s.name !== S.filterType) return [];
      return (s.questions||[]).map(q=>({...q, _section:s.name}));
    });

    if (S.mode === 'weak'){
      const weak = flat.filter(q=>{
        const k = keyFor(q); const p = S.perf[k]||{seen:0,good:0,bad:0};
        const acc = p.seen ? p.good/p.seen : 1;
        return (p.seen>=2 && acc<0.6) || S.reviewSet.has(k);
      });
      flat = weak.length ? weak : flat;
    }

    if (S.mode === 'random' || S.mode === 'weak' || S.mode === 'exam30' || S.mode === 'flash'){
      shuffle(flat);
    }
    S.queue = flat;
    el('qTotal').textContent = S.queue.length;
    el('modeLabel').textContent = S.mode;
    updateTimerBadge();
    updateStatsPanel();
  }

  function setupExamTimerIfNeeded(){
    stopTimer();
    if(S.mode === 'exam30'){
      S.timer.active = true;
      S.timer.left = 30*60;
      S.timer.t = setInterval(()=>{
        S.timer.left--;
        if(S.timer.left<=0){ S.timer.left=0; stopTimer(); endSession("‚è± Temps √©coul√© ‚Äì examen termin√©."); }
        updateTimerBadge();
      }, 1000);
      updateTimerBadge();
    }
  }

  function stopTimer(){ if(S.timer.t){ clearInterval(S.timer.t); } S.timer = {active:false,left:0,t:null}; updateTimerBadge(); }
  function updateTimerBadge(){
    const b = el('timerBadge');
    if(S.mode === 'exam30'){
      const m = Math.floor(S.timer.left/60), s = S.timer.left%60;
      b.textContent = `‚è± Examen ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    } else { b.textContent = 'Sans minuteur'; }
  }

  function getCurrent(){
    const subj = S.bank.subjects[S.subjectIndex];
    const q = S.queue[S.qIndex];
    return {subj, q, total: S.queue.length};
  }

  function renderIdle(){
    el('stage').innerHTML = `<div class="p">
      <h2 style="margin:0 0 6px">Bienvenue üëã</h2>
      <p style="color:var(--muted)">Place tes fichiers <b>.json</b> √† la <b>racine</b> du d√©p√¥t : l‚Äôapp les d√©tecte et les fusionne automatiquement (API GitHub).<br/>Choisis la mati√®re, le mode et un filtre si besoin. R√©ponse juste = <b>+1</b>, erreur = <b>‚àí1</b>.</p>
    </div>`;
  }

  function render(){
    const {subj, q, total} = getCurrent();
    if(!subj || !q){ renderIdle(); el('qIndex').textContent='0'; el('qTotal').textContent=total||0; el('progressBar').style.width='0%'; return; }

    el('subjectLabel').textContent = subj.name;
    el('qIndex').textContent = Math.min(S.qIndex+1, total);
    el('qTotal').textContent = total;
    el('score').textContent = S.score;
    el('progressBar').style.width = total? ((S.qIndex)/total*100).toFixed(1)+'%':'0%';

    el('stage').innerHTML = renderQuestion(q);

    const form = el('qForm'); if(form){ form.onsubmit = (ev)=>{ev.preventDefault(); submitAnswer(q)}; }

    const r = document.getElementById('btnReveal');
    const k = document.getElementById('btnKnow');
    const d = document.getElementById('btnDont');
    const a = document.getElementById('flashAnswer');
    if(r) r.onclick = ()=>{ if(a) a.style.display='block'; };
    if(k) k.onclick = ()=> window.__flashJudge && window.__flashJudge(true);
    if(d) d.onclick = ()=> window.__flashJudge && window.__flashJudge(false);

    updateExplain(false); updateReviewBadge();
  }

  function renderQuestion(q){
    if (S.mode === 'flash'){
      const media = (q.type==='image-id' && q.image) ? `<div class="imgwrap" style="margin-bottom:10px"><img src="${q.image}" alt="image"/></div>` : '';
      return `<div class="grid">
        <div class="row" style="align-items:center; justify-content:space-between; margin-bottom:8px">
          <div class="badge">Section: ${q._section||''}</div>
          <div class="badge ${S.reviewSet.has(keyFor(q))?'ok':'ghost'}">√Ä revoir</div>
        </div>
        <div class="q-title">${escapeHTML(q.prompt||'')}</div>
        <hr class="h"/>
        ${media}
        <div id="flashAnswer" style="display:none">${renderAnswerBlock(q)}</div>
        <div class="actions"><button id="btnReveal">Afficher la r√©ponse</button>
          <button id="btnKnow" class="ghost">Je savais (+1)</button>
          <button id="btnDont" class="ghost">Je ne savais pas (‚àí1)</button></div>
      </div>`;
    }

    const common = `<div class="row" style="align-items:center; justify-content:space-between; margin-bottom:8px">
        <div class="badge">Section: ${q._section||''}</div>
        <div class="badge ${S.reviewSet.has(keyFor(q))?'ok':'ghost'}">√Ä revoir</div>
      </div>
      <div class="q-title">${escapeHTML(q.prompt||'')}</div>
      <hr class="h"/>`;

    if(q.type === 'mcq'){
      const opts = (q.choices||[]).map((c,i)=>`<label class="choice"><input type="radio" name="c" value="${i}" required><div>${escapeHTML(c)}</div></label>`).join('');
      return `<form id="qForm" class="grid" autocomplete="off">${common}
        <div class="choices">${opts}</div>
        <div class="actions"><button id="btnSubmit">Valider</button></div>
        <div id="feedback"></div>
        <details id="explain"><summary class="p">Voir l'explication</summary><div class="p">${escapeHTML(q.explain||'')}</div></details>
      </form>`;
    }
    if(q.type === 'short'){
      return `<form id="qForm" class="grid" autocomplete="off">${common}
        <input type="text" id="shortAns" placeholder="√âcris ta r√©ponse" required />
        <div class="actions"><button id="btnSubmit">Valider</button></div>
        <div id="feedback"></div>
        <details id="explain"><summary class="p">Voir l'explication</summary><div class="p">${escapeHTML(q.explain||'')}</div></details>
      </form>`;
    }
    if(q.type === 'image-id'){
      const img = q.image ? `<div class="imgwrap"><img src="${q.image}" alt="image √† identifier" onerror="this.alt='(image introuvable)'; this.style.opacity=.6;"/></div>` : '';
      if(q.mode === 'mcq'){
        const opts = (q.choices||[]).map((c,i)=>`<label class="choice"><input type="radio" name="c" value="${i}" required><div>${escapeHTML(c)}</div></label>`).join('');
        return `<form id="qForm" class="grid" autocomplete="off">${common}
          ${img}
          <div class="choices">${opts}</div>
          <div class="actions"><button id="btnSubmit">Valider</button></div>
          <div id="feedback"></div>
          <details id="explain"><summary class="p">Voir l'explication</summary><div class="p">${escapeHTML(q.explain||'')}</div></details>
        </form>`;
      } else {
        return `<form id="qForm" class="grid" autocomplete="off">${common}
          ${img}
          <input type="text" id="shortAns" placeholder="Nom exact‚Ä¶" required />
          <div class="actions"><button id="btnSubmit">Valider</button></div>
          <div id="feedback"></div>
          <details id="explain"><summary class="p">Voir l'explication</summary><div class="p">${escapeHTML(q.explain||'')}</div></details>
        </form>`;
      }
    }
    return `<div class="p">Type non support√©.</div>`;
  }

  function renderAnswerBlock(q){
    if(q.type==='mcq'){
      const ans = q.choices && q.choices[q.answer]!==undefined ? q.choices[q.answer] : '(?)';
      return `<div class="pill ok">R√©ponse: ${escapeHTML(ans)}</div><div style="margin-top:8px; color:var(--muted)">${escapeHTML(q.explain||'')}</div>`;
    }
    if(q.type==='short' || (q.type==='image-id' && q.mode!=='mcq')){
      return `<div class="pill ok">R√©ponse: ${escapeHTML(q.answer_text||'(?)')}</div><div style="margin-top:8px; color:var(--muted)">${escapeHTML(q.explain||'')}</div>`;
    }
    if(q.type==='image-id' && q.mode==='mcq'){
      const ans = q.choices && q.choices[q.answer]!==undefined ? q.choices[q.answer] : '(?)';
      return `<div class="pill ok">R√©ponse: ${escapeHTML(ans)}</div><div style="margin-top:8px; color:var(--muted)">${escapeHTML(q.explain||'')}</div>`;
    }
    return '';
  }

  function keyFor(q){ return (q.prompt||'').slice(0,128); }

  function submitAnswer(q){
    if(S.answered) return;
    S.answered = true;
    let ok=false;

    if(q.type==='mcq'){
      const v = parseInt(document.querySelector('input[name="c"]:checked')?.value||'-1',10);
      ok = (v === q.answer);
    } else if(q.type==='short' || (q.type==='image-id' && q.mode!=='mcq')){
      const v = (el('shortAns').value||'').trim().toLowerCase();
      const a = (q.answer_text||'').trim().toLowerCase();
      ok = normalize(v) === normalize(a);
    } else if(q.type==='image-id' && q.mode==='mcq'){
      const v = parseInt(document.querySelector('input[name="c"]:checked')?.value||'-1',10);
      ok = (v === q.answer);
    }

    judgeAndLock(q, ok);
  }

  window.__flashJudge = function(ok){
    const {q} = getCurrent(); if(!q) return;
    judgeAndLock(q, ok);
  }

  function judgeAndLock(q, ok){
    S.score += ok ? 1 : -1; el('score').textContent = S.score;
    S.streak = ok ? (S.streak+1) : 0;
    const fb = el('feedback');
    if(fb) fb.innerHTML = ok ? `<div class="pill ok">‚úî R√©ponse correcte (+1)</div>` : `<div class="pill bad">‚úñ Mauvaise r√©ponse (‚àí1)</div>`;

    const k = keyFor(q);
    if(!S.perf[k]) S.perf[k] = {seen:0,good:0,bad:0};
    S.perf[k].seen++; ok ? S.perf[k].good++ : S.perf[k].bad++;
    updateStatsPanel();

    const form = el('qForm'); if(form){ form.querySelectorAll('input, button').forEach(x=> x.disabled = true); }
  }

  function nav(dir){
    const {total} = getCurrent();
    if(!total){ return; }
    S.qIndex += dir;
    if(S.qIndex < 0) S.qIndex = 0;
    if(S.qIndex >= total){
      endSession("üéâ Tu as parcouru toutes les questions de cette file.");
      S.qIndex = total-1;
      return;
    }
    S.answered = false;
    render();
  }

  function endSession(msg){
    const good = totalGood(), bad = totalBad(), seen = good+bad;
    const acc = seen? Math.round(good/seen*100):0;
    el('stage').innerHTML = `<div class="p">
      <h3 style="margin:4px 0 8px">Session termin√©e</h3>
      <p class="pill ok">Score: ${S.score}</p>
      <p class="badge">Vues: ${seen} ‚Ä¢ Bonnes: ${good} ‚Ä¢ Mauvaises: ${bad} ‚Ä¢ Pr√©cision: ${acc}%</p>
      <p style="color:var(--muted)">${escapeHTML(msg||'')}</p>
    </div>`;
    stopTimer();
  }

  function reset(){ stopTimer(); S.qIndex=0; S.score=0; S.answered=false; S.streak=0; render(); }
  function toggleExplain(){ const d = document.getElementById('explain'); if(d) d.open = !d.open; }

  function toggleReview(){
    const cur = getCurrent().q; if(!cur) return;
    const k = keyFor(cur);
    if(S.reviewSet.has(k)) S.reviewSet.delete(k); else S.reviewSet.add(k);
    updateReviewBadge(); updateStatsPanel();
  }
  function updateReviewBadge(){
    const cur = getCurrent().q; if(!cur) return;
    const badge = document.querySelector('.badge.ok, .badge.ghost'); if(!badge) return;
    const k = keyFor(cur); badge.className = 'badge ' + (S.reviewSet.has(k)?'ok':'ghost');
  }

  function saveBank(){
    const blob = new Blob([JSON.stringify(S.bank,null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'banque_questions.json'; a.click();
  }

  async function onImport(ev){
    const file = ev.target.files[0]; if(!file) return;
    try{
      const text = await file.text();
      const json = JSON.parse(text);
      if(!json.subjects) throw new Error('Format invalide: cl√© "subjects" manquante');
      S.bank = json; localStorage.setItem('qcm_bank_v1', JSON.stringify(S.bank));
      refreshSubjectList(); buildQueue(); renderIdle();
    }catch(e){ alert('Erreur d\'import: '+ e.message); }
    finally { ev.target.value = ''; }
  }

  function totalSeen(){ return Object.values(S.perf).reduce((a,p)=>a+p.seen,0); }
  function totalGood(){ return Object.values(S.perf).reduce((a,p)=>a+p.good,0); }
  function totalBad(){ return Object.values(S.perf).reduce((a,p)=>a+p.bad,0); }
  function updateStatsPanel(){
    const seen = totalSeen(), good = totalGood(), bad = totalBad();
    const acc = seen? Math.round(good/seen*100):0;
    el('stSeen').textContent = seen; el('stGood').textContent = good; el('stBad').textContent = bad;
    el('stAcc').textContent = acc + '%'; el('stStreak').textContent = S.streak; el('stToReview').textContent = S.reviewSet.size;
  }

  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function normalize(s){ return (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9]+/g,''); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  init();
  </script>
</body>
</html>

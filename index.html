<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QCM by Martial H. â€“ RÃ©vision Licence GCB</title>
  <meta name="theme-color" content="#0b0f1a" />
  <style>
    :root{
      --bg:#0b0f1a;--panel:#10162a;--panel2:#0e1324;--acc:#6df0ff;--acc2:#7d7bff;--ok:#2ee59d;--bad:#ff5577;--text:#e9f3ff;--muted:#9fb2c7;--chip:#16213a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial; background:radial-gradient(1200px 700px at 70% -10%,rgba(125,123,255,.16),transparent),
      radial-gradient(900px 600px at -20% 120%,rgba(109,240,255,.18),transparent), var(--bg); color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .app{max-width:760px; margin:0 auto; padding:12px 12px 84px;} /* plus lÃ©ger en bas, plus de barre fixe */
    header{
      position:sticky; top:0; z-index:5; backdrop-filter:saturate(130%) blur(10px);
      background:linear-gradient(180deg, rgba(11,15,26,.92), rgba(11,15,26,.65));
      border-bottom:1px solid rgba(125,123,255,.25);
    }
    .bar{display:flex; align-items:center; gap:8px; padding:10px 12px;}
    .title{font-weight:700; letter-spacing:.2px;}
    .chip{background:var(--chip); border:1px solid rgba(109,240,255,.25); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
    select, button, input[type="text"], textarea{
      background:linear-gradient(180deg,var(--panel),var(--panel2)); color:var(--text); border:1px solid rgba(125,123,255,.35); border-radius:12px;
      padding:10px 12px; font-size:14px; outline:none; width:100%;
    }
    button{cursor:pointer; transition:.2s transform ease, .2s box-shadow ease;}
    button:hover{transform:translateY(-1px)}
    .row{display:flex; gap:8px;}
    .row>*{flex:1}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:520px){
      .grid-2{grid-template-columns: 1fr 1fr}
    }
    .panel{border:1px solid rgba(109,240,255,.2); border-radius:16px; background:linear-gradient(180deg, rgba(22,28,50,.72), rgba(12,17,33,.72)); box-shadow:0 8px 24px rgba(0,0,0,.25);}
    .panel .p{padding:14px;}
    .ghost{background:transparent; border:1px dashed rgba(125,123,255,.35)}
    .progress{height:8px; width:100%; background:#0b1120; border-radius:999px; overflow:hidden; border:1px solid rgba(125,123,255,.25)}
    .progress>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--acc),var(--acc2)); transition:width .25s ease}
    .badge{padding:6px 10px; border-radius:999px; border:1px solid rgba(125,123,255,.35); font-size:12px; color:var(--muted)}
    .q-title{font-weight:700; font-size:18px; line-height:1.3}
    .choices{display:grid; gap:10px;}
    .choice{display:flex; gap:10px; align-items:flex-start; padding:10px; border:1px solid rgba(125,123,255,.35); border-radius:12px; background:linear-gradient(180deg,var(--panel),var(--panel2)); cursor:pointer}
    .choice input{margin-top:4px}
    .actions{display:flex; gap:10px;}
    .h{height:1px; background:linear-gradient(90deg, transparent, rgba(109,240,255,.35), transparent); border:0; margin:12px 0}
    .score{font-weight:700}
    .pill{padding:4px 8px; border-radius:999px;}
    .ok{color:#062; background:linear-gradient(180deg, rgba(46,229,157,.25), rgba(46,229,157,.1)); border:1px solid rgba(46,229,157,.4)}
    .bad{color:#620; background:linear-gradient(180deg, rgba(255,85,119,.25), rgba(255,85,119,.1)); border:1px solid rgba(255,85,119,.4)}
    .imgwrap{border:1px solid rgba(125,123,255,.35); border-radius:12px; overflow:hidden; background:#0b1120}
    .imgwrap img{display:block; width:100%; height:auto}

    /* === Bouton flottant & panneau pliable === */
    .fab{
      position:fixed; right:16px; bottom:calc(16px + env(safe-area-inset-bottom, 0px));
      z-index:20; width:48px; height:48px; border-radius:999px; display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(125,123,255,.35); background:linear-gradient(180deg,var(--panel),var(--panel2));
      box-shadow:0 8px 24px rgba(0,0,0,.35); font-size:20px; user-select:none;
    }
    .sheet-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.25); backdrop-filter: blur(1px);
      opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:18;
    }
    .sheet{
      position:fixed; left:0; right:0; bottom:0; z-index:19;
      transform:translateY(110%); transition:transform .24s ease;
      padding:12px 12px calc(18px + env(safe-area-inset-bottom,0px));
      background:linear-gradient(180deg, rgba(11,15,26,.0), rgba(11,15,26,.95));
      border-top:1px solid rgba(125,123,255,.25);
      box-shadow:0 -12px 24px rgba(0,0,0,.35);
    }
    .sheet.open{ transform:translateY(0%); }
    .sheet-backdrop.open{ opacity:1; pointer-events:auto; }
    .sheet .row{ gap:10px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">ðŸ“š RÃ©visions GCB â€“ OBJECTIF "REUSSIR"</div>
      <div class="chip" id="version">v1.3</div>
    </div>
    <div class="bar" style="gap:10px; flex-wrap:wrap">
      <div class="row" style="flex:3">
        <select id="subjectSelect" aria-label="Choisir une matiÃ¨re"></select>
        <button id="btnStart">DÃ©marrer</button>
      </div>
      <!-- Importer / Exporter supprimÃ©s -->
    </div>
  </header>

  <div class="app">
    <div class="grid">
      <div class="panel">
        <div class="p">
          <div class="row" style="align-items:center; gap:12px">
            <div class="badge">Sans minuteur</div>
            <div class="badge">Score: <span class="score" id="score">0</span></div>
            <div class="badge">Question <span id="qIndex">0</span>/<span id="qTotal">0</span></div>
            <div class="badge">MatiÃ¨re: <span id="subjectLabel">â€”</span></div>
          </div>
          <div class="progress" style="margin:10px 0 4px"><i id="progressBar"></i></div>
        </div>
      </div>

      <div class="panel" id="card">
        <div class="p" id="stage">
          <p style="color:var(--muted); margin:0">
            Les banques de questions sont chargÃ©es <b>automatiquement</b> depuis la racine du dÃ©pÃ´t.
            Choisis une matiÃ¨re puis clique <b>DÃ©marrer</b>.
          </p>
        </div>
      </div>

      <div class="panel">
        <div class="p grid-2">
          <button id="btnPrev">âŸµ PrÃ©cÃ©dent</button>
          <button id="btnNext">Suivant âŸ¶</button>
        </div>
      </div>

      <!-- Panneau 'Format de la banque' supprimÃ© -->
    </div>
  </div>

  <!-- Bouton flottant + panneau pliable -->
  <button class="fab" id="toolsFab" aria-controls="toolsSheet" aria-expanded="false" title="Outils">â‹¯</button>
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="toolsSheet" role="dialog" aria-modal="false" aria-label="Outils de rÃ©vision">
    <div class="app">
      <div class="row">
        <button id="btnMarkReview" class="ghost">Marquer Ã  revoir</button>
        <button id="btnShowExplain" class="ghost">Afficher l'explication</button>
        <button id="btnReset" class="ghost">RÃ©initialiser la session</button>
      </div>
    </div>
  </div>

  <script>
  // --- State ---
  const el = (id)=>document.getElementById(id);
  const S = {
    bank: { subjects: [] },
    subjectIndex: -1,
    sectionIndex: 0,
    qIndex: 0,
    score: 0,
    answered: false,
    reviewSet: new Set(),
  };

  // --- Chargement auto depuis la racine du dÃ©pÃ´t ---
  const ROOT_FILES = [
    "bacteriologie_300.json",
    "biochimie_analytique_300.json",
    "biochimie_medicale_300.json",
    "biochimie_structurale_300.json",
    "chimie_analytique_300.json",
    "chimie_minerale_300.json",
    "chimie_organique_300.json",
    "hematologie_300.json",
    "hematologie_plus_300.json",
    "hemogrammes_interpretation_200.json",
    "immunologie_300.json",
    "parasito_300.json",
    "identification_images_all.json"
  ];

  // --- Demo minimal (fallback) ---
  const demo = {
    subjects:[
      { name:"BactÃ©riologie", sections:[
        {name:"QCM", questions:[
          {type:"mcq", prompt:"Les bacilles Gram nÃ©gatif parmi les suivants sont :", choices:["Staphylococcus","Escherichia coli","Streptococcus"], answer:1, explain:"E. coli est un bacille Gram nÃ©gatif."},
          {type:"mcq", prompt:"La stÃ©rilisation Ã©limine :", choices:["Seulement les bactÃ©ries","Tous les micro-organismes et spores","Seulement les virus"], answer:1, explain:"Destruction totale y compris spores."}
        ]},
        {name:"Questions/RÃ©ponses", questions:[
          {type:"short", prompt:"DÃ©finir antisepsie.", answer_text:"ProcÃ©dÃ© visant Ã  dÃ©truire ou inhiber les micro-organismes sur les tissus vivants.", explain:"Antisepsie â‰  dÃ©sinfection (milieux inertes)."}
        ]},
        {name:"IDENTIFICATION IMAGE", questions:[
          {type:"image-id", prompt:"Identifier la morphologie.", image:"demo_gram.jpg", mode:"text", answer_text:"Cocci en amas", explain:"Aspect typique des staphylocoques."}
        ]}
      ]}
    ]
  };

  async function autoLoadRoot(){
    const merged = { subjects: [] };
    for(const file of ROOT_FILES){
      try{
        const res = await fetch(file, {cache:'no-store'});
        if(!res.ok) continue;
        const json = await res.json();
        if(json && Array.isArray(json.subjects)){
          merged.subjects.push(...json.subjects);
        }
      }catch(e){ /* ignore */ }
    }
    if(merged.subjects.length){
      S.bank = merged;
      localStorage.setItem('qcm_bank_v1', JSON.stringify(S.bank));
    }else{
      S.bank = demo;
    }
    refreshSubjectList();
    renderIdle();
  }

  // --- Init ---
  function init(){
    const saved = localStorage.getItem('qcm_bank_v1');
    S.bank = saved ? JSON.parse(saved) : demo;
    refreshSubjectList();
    bind();
    renderIdle();
    autoLoadRoot();
  }

  function bind(){
    el('btnStart').onclick = start;
    el('btnNext').onclick = ()=> nav(1);
    el('btnPrev').onclick = ()=> nav(-1);
    el('btnReset').onclick = reset;
    el('btnShowExplain').onclick = toggleExplain;
    el('btnMarkReview').onclick = toggleReview;

    // FAB / Sheet
    const fab = el('toolsFab'), sheet = el('toolsSheet'), backdrop = el('sheetBackdrop');
    const setOpen = (open)=>{
      sheet.classList.toggle('open', open);
      backdrop.classList.toggle('open', open);
      fab.setAttribute('aria-expanded', open ? 'true' : 'false');
    };
    fab.onclick = ()=> setOpen(!sheet.classList.contains('open'));
    backdrop.onclick = ()=> setOpen(false);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') setOpen(false); });
  }

  function refreshSubjectList(){
    const sel = el('subjectSelect'); sel.innerHTML='';
    (S.bank.subjects||[]).forEach((s, i)=>{
      const o=document.createElement('option'); o.value=i; o.textContent=s.name; sel.appendChild(o);
    });
  }

  function start(){
    const idx = parseInt(el('subjectSelect').value || '0',10);
    S.subjectIndex = isNaN(idx) ? 0 : idx; S.sectionIndex = 0; S.qIndex = 0; S.score = 0; S.answered=false; S.reviewSet.clear();
    render();
  }

  function getCurrent(){
    const subj = (S.bank.subjects||[])[S.subjectIndex];
    if(!subj) return {};
    const flat = subj.sections.flatMap(s=>s.questions.map(q=>({...q, _section:s.name})));
    const q = flat[S.qIndex];
    return {subj, q, total: flat.length};
  }

  function renderIdle(){
    el('stage').innerHTML = `<div class="p">
      <h2 style="margin:0 0 6px">Bienvenue ðŸ‘‹</h2>
      <p style="color:var(--muted)">Banques chargÃ©es automatiquement depuis la racine. RÃ©ponse juste = <b>+1</b>, erreur = <b>-1</b>. Pas de minuteur.</p>
    </div>`;
  }

  function render(){
    const {subj, q, total} = getCurrent();
    if(!subj){ renderIdle(); return; }

    el('subjectLabel').textContent = subj.name || 'â€”';
    el('qIndex').textContent = Math.min(S.qIndex+1, total||0);
    el('qTotal').textContent = total||0;
    el('score').textContent = S.score;
    el('progressBar').style.width = total? ((S.qIndex)/total*100).toFixed(1)+'%':'0%';

    if(!q){ el('stage').innerHTML = `<div class="p">Aucune question.</div>`; return; }

    el('stage').innerHTML = renderQuestion(q);

    const form = el('qForm');
    if(form){ form.onsubmit = (ev)=>{ev.preventDefault(); submitAnswer(q)}; }

    updateExplain(false);
    updateReviewBadge();
  }

  function renderQuestion(q){
    const common = `<div class="row" style="align-items:center; justify-content:space-between; margin-bottom:8px">
        <div class="badge">Section: ${q._section||''}</div>
        <div class="badge ${S.reviewSet.has(keyFor(q))?'ok':'ghost'}">Ã€ revoir</div>
      </div>
      <div class="q-title">${escapeHTML(q.prompt||'')}</div>
      <hr class="h"/>`;

    if(q.type === 'mcq'){
      const opts = (q.choices||[]).map((c,i)=>`<label class="choice"><input type="radio" name="c" value="${i}" required><div>${escapeHTML(c)}</div></label>`).join('');
      return `<form id="qForm" class="grid" autocomplete="off">${common}
        <div class="choices">${opts}</div>
        <div class="actions"><button id="btnSubmit">Valider</button></div>
        <div id="feedback"></div>
        <details id="explain"><summary class="p">Voir l'explication</summary><div class="p">${escapeHTML(q.explain||'')}</div></details>
      </form>`;
    }
    if(q.type === 'short'){
      return `<form id="qForm" class="grid" autocomplete="off">${common}
        <input type="text" id="shortAns" placeholder="Ã‰cris ta rÃ©ponse" required />
        <div class="actions"><button id="btnSubmit">Valider</button></div>
        <div id="feedback"></div>
        <details id="explain"><summary class="p">Voir l'explication</summary><div class="p">${escapeHTML(q.explain||'')}</div></details>
      </form>`;
    }
    if(q.type === 'image-id'){
      const img = q.image ? `<div class="imgwrap"><img src="${q.image}" alt="image Ã  identifier" onerror="this.alt='(image introuvable)'; this.style.opacity=.6;"/></div>` : '';
      if(q.mode === 'mcq'){
        const opts = (q.choices||[]).map((c,i)=>`<label class="choice"><input type="radio" name="c" value="${i}" required><div>${escapeHTML(c)}</div></label>`).join('');
        return `<form id="qForm" class="grid" autocomplete="off">${common}
          ${img}
          <div class="choices">${opts}</div>
          <div class="actions"><button id="btnSubmit">Valider</button></div>
          <div id="feedback"></div>
          <details id="explain"><summary class="p">Voir l'explication</summary><div class="p">${escapeHTML(q.explain||'')}</div></details>
        </form>`;
      } else {
        return `<form id="qForm" class="grid" autocomplete="off">${common}
          ${img}
          <input type="text" id="shortAns" placeholder="Nom exactâ€¦" required />
          <div class="actions"><button id="btnSubmit">Valider</button></div>
          <div id="feedback"></div>
          <details id="explain"><summary class="p">Voir l'explication</summary><div class="p">${escapeHTML(q.explain||'')}</div></details>
        </form>`;
      }
    }
    return `<div class="p">Type non supportÃ©.</div>`;
  }

  function keyFor(q){ return (q.prompt||'').slice(0,64); }

  function submitAnswer(q){
    if(S.answered) return;
    S.answered = true;
    let ok=false;

    if(q.type==='mcq'){
      const v = parseInt(document.querySelector('input[name="c"]:checked')?.value||'-1',10);
      ok = (v === q.answer);
    } else if(q.type==='short' || (q.type==='image-id' && q.mode!=='mcq')){
      const v = (el('shortAns').value||'').trim().toLowerCase();
      const a = (q.answer_text||'').trim().toLowerCase();
      ok = normalize(v) === normalize(a);
    } else if(q.type==='image-id' && q.mode==='mcq'){
      const v = parseInt(document.querySelector('input[name="c"]:checked')?.value||'-1',10);
      ok = (v === q.answer);
    }

    S.score += ok ? 1 : -1; el('score').textContent = S.score;
    const fb = el('feedback');
    fb.innerHTML = ok ? `<div class="pill ok">âœ” RÃ©ponse correcte (+1)</div>` : `<div class="pill bad">âœ– Mauvaise rÃ©ponse (âˆ’1)</div>`;

    const form = el('qForm'); if(form){ form.querySelectorAll('input, button').forEach(x=> x.disabled = true); }
  }

  function nav(dir){
    const {total} = getCurrent();
    S.qIndex = Math.max(0, Math.min((total||1)-1, S.qIndex + dir));
    S.answered = false;
    render();
  }

  function reset(){ S.qIndex=0; S.score=0; S.answered=false; render(); }

  function toggleExplain(){
    const d = document.getElementById('explain');
    if(d) d.open = !d.open;
  }

  function toggleReview(){
    const cur = getCurrent().q; if(!cur) return;
    const k = keyFor(cur);
    if(S.reviewSet.has(k)) S.reviewSet.delete(k); else S.reviewSet.add(k);
    updateReviewBadge();
  }
  function updateReviewBadge(){
    const cur = getCurrent().q; if(!cur) return;
    const badge = document.querySelector('.badge.ok, .badge.ghost');
    if(!badge) return;
    const k = keyFor(cur);
    badge.className = 'badge ' + (S.reviewSet.has(k)?'ok':'ghost');
  }

  // utils
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function normalize(s){
    return (s||'')
      .toLowerCase()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu,'')
      .replace(/[^a-z0-9]+/g,'')
  }

  init();
  </script>
</body>
</html>
